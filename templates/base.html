{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        {% block meta %}{% endblock meta %}
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="{% static 'css/global.css' %}" />
        <link rel="stylesheet" href="{% static 'css/style.css' %}" />
        <link
        rel="stylesheet"
        type="text/css"
        href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
        />
    </head>

    <body class="pt-16">
        {% include 'navbar.html' %}
        {% block content %}{% endblock %}
        {% include 'modal.html' %}

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

        {# ---- CSRF Setup ---- #}
        <script>
        const csrftoken =
            document.querySelector("[name=csrfmiddlewaretoken]")?.value;
        if (csrftoken) {
            $.ajaxSetup({
            beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            });
        }

        function getCookie(name) {
            let v = null;
            document.cookie.split(";").forEach(function (c) {
            const cookie = c.trim();
            if (cookie.startsWith(name + "="))
                v = decodeURIComponent(cookie.substring(name.length + 1));
            });
            return v;
        }
        </script>

        {# ---- Toastify Helper ---- #}
        <script>
        function showToast(message, type = "success") {
            const colors = {
            success: "linear-gradient(to right, #00b09b, #96c93d)",
            error: "linear-gradient(to right, #ff5f6d, #ffc371)",
            info: "linear-gradient(to right, #4facfe, #00f2fe)",
            };

            Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            style: { background: colors[type] || colors.info },
            }).showToast();
        }
        </script>


        <script>
        (function () {
            const csrftoken = getCookie("csrftoken");
            const container = document.getElementById("product-list-container");
            const loadingEl = document.getElementById("product-loading");
            const emptyEl = document.getElementById("product-empty");
            const errorEl = document.getElementById("product-error");
            const refreshBtn = document.getElementById("refresh-products-btn");

            function show(el) {
            if (el) el.classList.remove("hidden");
            }
            function hide(el) {
            if (el) el.classList.add("hidden");
            }

            async function fetchProductList() {
            if (!container) return;
            hide(errorEl);
            hide(emptyEl);

            loadingEl.classList.remove("hidden", "opacity-0");
            loadingEl.classList.add("opacity-100", "transition-opacity", "duration-300");

            if (refreshBtn) refreshBtn.disabled = true;

            try {
                const resp = await fetch("{% url 'main:ajax_product_list' %}", {
                headers: { "X-Requested-With": "XMLHttpRequest" },
                credentials: "same-origin",
                });
                if (!resp.ok) throw new Error(resp.statusText);
                const html = await resp.text();
                container.innerHTML = html;

                const grid = container.querySelector("#product-grid");
                const cards = grid ? grid.children.length : 0;
                if (!cards) show(emptyEl);

                showToast("Products refreshed!");
            } catch (err) {
                console.error("Fetch error", err);
                show(errorEl);
                showToast("Failed to load products", "error");
            } finally {
                if (refreshBtn) refreshBtn.disabled = false;
                loadingEl.classList.add("opacity-0");
                setTimeout(() => hide(loadingEl), 300);
            }
            }

            if (refreshBtn)
            refreshBtn.addEventListener("click", (e) => {
                e.preventDefault();
                fetchProductList();
            });

            window.fetchProductList = fetchProductList;
        })();
        </script>


        <script>
        (function () {
            const csrftoken = getCookie("csrftoken");
            const formModal = document.getElementById("form-modal");
            const formModalBody = document.getElementById("form-modal-body");
            const formModalTitle = document.getElementById("form-modal-title");

            document.addEventListener("click", async function (e) {
            const btn = e.target.closest(".edit-btn");
            if (!btn) return;
            e.preventDefault();

            const url = btn.dataset.editUrl;
            if (!url) return;

            try {
                const resp = await fetch(url, {
                headers: { "X-Requested-With": "XMLHttpRequest" },
                credentials: "same-origin",
                });
                if (!resp.ok) throw new Error(resp.statusText);
                const html = await resp.text();

                formModalBody.innerHTML = html;
                formModalTitle.textContent = "Edit Product";
                showModal("form-modal");
                document.body.style.overflow = "hidden";

                const form = formModalBody.querySelector("form");
                if (form) {
                form.addEventListener("submit", async (ev) => {
                    ev.preventDefault();
                    const fd = new FormData(form);
                    try {
                    const save = await fetch(form.action, {
                        method: form.method || "POST",
                        headers: {
                        "X-CSRFToken": csrftoken,
                        "X-Requested-With": "XMLHttpRequest",
                        },
                        credentials: "same-origin",
                        body: fd,
                    });
                    const data = await save.json();
                    if (data.status === "success") {
                        showToast("Product updated successfully!");
                        hideModal("form-modal");
                        document.body.style.overflow = "";
                        if (typeof fetchProductList === "function")
                        fetchProductList();
                    } else {
                        showToast("Failed to update product", "error");
                    }
                    } catch (err) {
                    console.error(err);
                    showToast("Error saving product", "error");
                    }
                });
                }
            } catch (err) {
                console.error(err);
                showToast("Could not load edit form", "error");
            }
            });

            document.addEventListener("keydown", (e) => {
            if (
                e.key === "Escape" &&
                !formModal.classList.contains("hidden")
            ) {
                hideModal("form-modal");
                document.body.style.overflow = "";
            }
            });
        })();
        </script>


        <script>
        (function () {
            const csrftoken = getCookie("csrftoken");

            document.addEventListener("click", async function (e) {
            const btn = e.target.closest(".delete-btn");
            if (!btn) return;
            e.preventDefault();

            const url = btn.dataset.deleteUrl;
            if (!url) {
                console.warn("Missing data-delete-url on button");
                return;
            }

            if (
                !confirm(
                "Are you sure you want to delete this product? This cannot be undone."
                )
            )
                return;

            try {
                const resp = await fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest",
                },
                credentials: "same-origin",
                });

                const data = await resp.json().catch(() => ({
                status: "success",
                }));

                if (data.status === "success") {
                showToast(data.message || "Product deleted successfully!");
                const card = btn.closest("article");
                if (card) card.remove();

                // Re-fetch product list dynamically (no page reload)
                if (typeof fetchProductList === "function") fetchProductList();
                } else {
                showToast(data.message || "Failed to delete product", "error");
                }
            } catch (err) {
                console.error("Error deleting product", err);
                showToast("Error deleting product", "error");
            }
            });
        })();
        </script>

        {% include 'modal.html' %}

        {# small server-generated config the JS can read (only URLs we need) #}
        <script>
            window.APP_URLS = {
                ajax_product_list: "{% url 'main:ajax_product_list' %}"
                // Note: edit/delete/get-form URLs are already rendered into each button in templates
            };
        </script>

        {# load the client-side JS (single file) #}
        <script src="{% static 'js/main.js' %}"></script>

        {% block script %}{% endblock script %}
    </body>
</html>
